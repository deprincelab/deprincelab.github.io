---
layout: page
math: true
---


<script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify
.js?lang=css&skin=desert"></script>

<style>
.border_gradient {
border: 8px solid #000;
padding: 5px 5px 5px 15px;
width: 300px;
}
code {
    background: hsl(220, 80%, 90%);
}

pre {
    padding-bottom: 20px;
    padding-left:   20px;
    border:solid;
    -moz-border-bottom-colors:#787878 #888888 #989898 #A8A8A8 #B8B8B8 #C8C8C8 #D8D8D8  #E8E8E8 #F8F8F8;
    -moz-border-top-colors:   #787878 #888888 #989898 #A8A8A8 #B8B8B8 #C8C8C8 #D8D8D8  #E8E8E8 #F8F8F8;
    -moz-border-left-colors:  #787878 #888888 #989898 #A8A8A8 #B8B8B8 #C8C8C8 #D8D8D8  #E8E8E8 #F8F8F8;
    -moz-border-right-colors: #787878 #888888 #989898 #A8A8A8 #B8B8B8 #C8C8C8 #D8D8D8  #E8E8E8 #F8F8F8;
    width:100%;
    background: #353535;
    color: white;
    text-indent: 1cm;
}
</style>

<br>

Programming Projects: Unrestricted MP2 <br>
<hr>

<br>
<br> 
Overview 
<div id="content" style="background-color:#000000;text-align:justify;height:1px;
width:50%">
</div>
<br>
<br>

In this project, you will develop code to evaluate the electronic energy using
unrestricted second-order M&oslash;ller-Pleset
perturbation theory (MP2) within the <span style="font-variant: small-caps;">Psi4</span> electronic structure
package.  MP2 is the simplest wave-function-based post-Hartree-Fock method for 
evaluating the dynamical correlation energy.  

<br>
<br>
<br>

The MP2 correlation energy
<div id="content" style="background-color:#000000;text-align:justify;height:1px;
width:50%">
</div>

<br>
<br>
In spin-orbital notation, the MP2 correlation energy is given by
<br>
$$E_\text{MP2} = E_\text{HF} + \frac{1}{4} \sum_{ijab} \frac{|\langle ij || ab \rangle|^2}{\epsilon_i+\epsilon_j-\epsilon_a-\epsilon_b}$$
Here, <i>E</i><sub>HF</sub> represents the unrestricted Hartree-Fock reference energy,
which includes the nuclear repulsion energy.  The four-index sum reflects
the idea that the MP2 energy includes contributions to the correlation energy
that arise from all doubly substituted electronic configurations;
the factor of 1/4 ensures that we do not double count excitations out of
the reference.  
The 
indices <i>i</i> and <i>j</i> refer to spin orbitals that are occupied in the
reference function,  
and the labels <i>a</i> and <i>b</i> refer to
spin orbitals that are unoccupied in the reference function (virtual orbitals).
Again, these sumations are over spin orbitals, which means that the index 
<i>i</i> spans all occupied orbitals of both &alpha; and
&beta; spin.  
<br>
<br>
The denominator in the MP2 energy expression consists of molecular orbital 
energies; these quantities are the eigenvalues of the &alpha;- and &beta;-spin
Fock matrices.  
The symbol &lt<i>ij</i>||<i>ab</i>&gt denotes an antisymmetrized 
two-electron repulsion integral in physicists' notation:
<br>
$$\langle ij || ab \rangle = \langle ij | ab \rangle - \langle ij | ba \rangle $$
The two-electron integrals in physicists' notation are related to those
in chemists' notation used in the previous tutorials by
<br>
$$\langle ij | ab \rangle = (ia|jb) $$
Note that the orbital labels refer to <i>molecular spin orbitals</i>.  The 
molecular orbital (MO) basis is the basis
of orthonormal orbitals generated by the Hartree-Fock procedure that diagonalizes 
the &alpha;- and &beta;-spin Fock matrices.  So, given a set of two-electron 
integrals in the atomic orbital basis, (<i>&mu;&nu;</i>|<i>&lambda;&sigma;</i>), the MO-basis
integrals can be obtained through the orbital transformation
<br>
$$(ia|jb) = \sum_{\mu\nu\lambda\sigma} (\mu\nu|\lambda \sigma) C_{\mu i} C_{\nu a} C_{\lambda j} C_{\sigma b}$$
Here, the transformation matrix, <i>C</i>, is the same orbital transformation
matrix determined through the Hartree-Fock procedure.
Note, however, that this transformation is given here in a very naive form.  
As written,
this transformation would scale with the eigth power of system size!  Instead,
one should perform a series of partial transformations that each scale only
as the fifth power of system size:
<br>
$$(i\nu|\lambda\sigma) = \sum_{\mu} (\mu\nu|\lambda \sigma) C_{\mu i} $$
$$(ia|\lambda\sigma) = \sum_{\nu} (i\nu|\lambda \sigma) C_{\nu a} $$
$$(ia|j\sigma) = \sum_{\lambda} (ia|\lambda \sigma) C_{\lambda j} $$
$$(ia|jb) = \sum_{\sigma} (ia|j \sigma) C_{\sigma b} $$
This integral transformation step is the source of the overall
fifth-power scaling of the MP2 approach.
<br>
<br>
<br>

Density fitting in MP2 
<div id="content" style="background-color:#000000;text-align:justify;height:1px;
width:50%">
</div>

<br>
<br>

As in Hartree-Fock theory, the density fitting (DF)
approximation to the two-electron repulsion integrals can
reduce the storage requirements and computational
effort required to evaluate the MP2 energy.  The primary utility
of the DF approximation is in reducing the scaling of the 
integral transformation step for MP2 from the fifth power with 
system size to the fourth power with system size.  The three-index
integral transformation can be carried out as two partial transformations
that carry fourth-power scaling:
<br>
$$(i\nu|Q) = \sum_\mu (\mu\nu|Q) C_{\mu i}$$
$$(ia|Q) = \sum_\nu (i\nu|Q) C_{\nu a}$$
The MO-basis four-index electron repulsion integral (ERI) tensor
can then be constructed at fifth-power cost as
<br>
$$(ia|jb) = \sum_Q (ia|Q)(Q|jb)$$
So, the DF approximation does not reduce the formal scaling of the MP2 
energy evaluation, but it does reduce the number of fifth-power-scaling
steps.  Conventional MP2 requires four fifth-power-scaling partial integral 
transformations,
while DF-MP2 requires only one fifth-power-scaling 
contraction to construct the four-index ERI tensor.
<br>
<br>
It is important to note here that the auxiliary basis used within a DF-MP2 
procedure is usually different than that used within a density-fitted 
Hartree-Fock procedure.  The reason is that the auxiliary basis sets are
separately optimized to give accurate results for either Hartree-Fock or
MP2, but not both.  Keep this in mind when comparing your results to
those from <span style="font-variant: small-caps;">Psi4</span>'s
built-in DF-MP2 function.

<br>
<br>
<br>

Procedure
<div id="content" style="background-color:#000000;text-align:justify;height:1px;
width:50%">
</div>

<br>
<br>

If you have completed the previous Hartree-Fock tutorials, you can add the
MP2 energy evaluation to the end of your plugin, after the Hartree-Fock
procedure converges.  Otherwise, create a new 
<span style="font-variant: small-caps;">Psi4</span> plugin, as described
<a href=http://www.chem.fsu.edu/~deprince/programming_projects/getting_started.php>here</a>.
Before moving on, open the input file in your plugin directory (input.dat)
and look at the molecule block
<br>
<br>
<pre class="prettyprint">

    molecule {
    O
    H 1 R
    H 1 R 2 A

    R = .9
    A = 104.5
    # add this line!
    symmetry c1
    }
</pre>
<br>
This plugin will not make use of point group symmetry, so you
should add a line specifying that the computation be performed
using C<sub>1</sub> symmetry.  Now, add a flag indicating that
the computation will use density fitting techniques in the
Hartree-Fock procedure:
<br>
<br>
<pre class="prettyprint">

set {
  #add this line!
  scf_type df
  basis sto-3g
}
</pre>
<br>
For the remainder of this
project, I've assumed that the rest of the input is unchanged.
Keep this in mind when comparing to my results.
<br>
<br>
Now, we must make sure that Psi4 also recognizes that we will be
using the DF approximation within our MP2 procedure.  Close 
input.dat and open pymodule.py.  Locate the line that contains
"Ensure IWL has been written".  The line following this one is meant to 
ensure that a plugin has access to the four-index integrals in
cases where the Hartree-Fock procedure used density fitting.
Since we will use the DF approximation in our MP2 procedure, we
do not need four-index integrals.  Comment out that line and
add a few additional lines that ensure that the reference wave
function passed into the plugin knows what density fitting basis
set is appropriate for our MP2 procedure:
<br>
<br>
<pre class="prettyprint">

    # Ensure IWL files have been written when not using DF/CD
    #proc_util.check_iwl_file_from_scf_type(psi4.core.get_option('SCF', 'SCF_TYPE'), ref_wfn)

    aux_basis = psi4.core.BasisSet.build(ref_wfn.molecule(), "DF_BASIS_MP2",
                                    psi4.core.get_option("DFMP2", "DF_BASIS_MP2"),
                                    "RIFIT", psi4.core.get_global_option('BASIS'))
    ref_wfn.set_basisset("DF_BASIS_MP2", aux_basis)
</pre>
<br>
In order to use
<span style="font-variant: small-caps;">Psi4</span>'s density fitting
capabilities and the Matrix, Vector, and Wavefunction classes,
we must include the corresponding
headers in plugin.cc.  If you are making this plugin from scratch, then you
will need to add the following:
<br>
<br>
<pre class="prettyprint">

#include "psi4/libmints/wavefunction.h"
#include "psi4/libmints/matrix.h"
#include "psi4/libmints/vector.h"
#include "psi4/libmints/basisset.h"
#include "psi4/lib3index/dftensor.h"
#include "psi4/libqt/qt.h"
</pre>
<br>

As in the previous tutorials, we can ask the reference wave function
passed into the plugin for some information about the system
(the number of &alpha; electrons, the orbital transformation matrices, etc.):
<br>
<br>

<pre class="prettyprint">

    // total number of alpha electrons 
    int na  = ref_wfn-&gtnalpha();

    // total number of beta electrons 
    int nb  = ref_wfn-&gtnbeta();

    // total number of basis functions
    int nso = ref_wfn-&gtnso();

    // total number of molecular orbitals
    int nmo = ref_wfn-&gtnmo();

    std::shared_ptr&ltMatrix&gt Ca = ref_wfn-&gtCa();
    std::shared_ptr&ltMatrix&gt Cb = ref_wfn-&gtCb();
</pre>
<br>
If you are writing your MP2 code as an extension to your previous
Hartree-Fock plugin, use the orbital transformation matrices
optimized by your procedure.  Now, use the DFTensor class to
generate three-index integrals in the atomic orbital basis.
Be sure to use the auxiliary basis set that is 
appropriate for MP2, as opposed to that for Hartree-Fock theory 
(<span style="font-variant: small-caps;">Psi4</span> refers to this basis as "DF_BASIS_MP2").
<br>

<pre class="prettyprint">

    // grab the molecule from the wavefunction that was passed into the plugin
    std::shared_ptr&ltMolecule&gt mol = ref_wfn-&gtmolecule();

    // get primary basis:
    std::shared_ptr&ltBasisSet&gt primary = ref_wfn-&gtget_basisset("ORBITAL");

    // get auxiliary basis:
    std::shared_ptr&ltBasisSet&gt auxiliary = ref_wfn-&gtget_basisset("DF_BASIS_MP2");

    // total number of auxiliary basis functions
    int nQ = auxiliary-&gtnbf();

    // construct the three-index integrals 
    std::shared_ptr&ltDFTensor&gt DF (new DFTensor(primary,auxiliary,Ca,na,nso-na,nb,nso-nb,options));
    std::shared_ptr&ltMatrix&gt Qso = DF-&gtQso();
</pre>
<br>
You can now use the &alpha;- and &beta;-spin MO transformatrices to
transform the three-index integrals from the atomic orbital basis
to the molecular orbital basis.  For unrestricted MP2, you will need
to separately transform &alpha;- and &beta;-spin tensors so that you
can eventually construct (&alpha;&alpha;|&alpha;&alpha;), (&alpha;&alpha;|&beta;&beta;),
and (&beta;&beta;|&beta;&beta;) type integrals.
<br>
<br>
The last necessary ingredient for the MP2 energy is the list of molecular orbital
energies.  You can grab these from the reference wavefunction:
<br>
<br>
<pre class="prettyprint">

    std::shared_ptr&ltVector&gt epsilon_a = std::shared_ptr&ltVector&gt(new Vector(nmo));
    epsilon_a-&gtcopy(reference_wavefunction_-&gtepsilon_a().get());

    std::shared_ptr&ltVector&gt epsilon_b = std::shared_ptr&ltVector&gt(new Vector(nmo));
    epsilon_b-&gtcopy(reference_wavefunction_-&gtepsilon_b().get());
</pre>
<br>
If you are writing this plugin as an extension of a previously 
completed Hartree-Fock plugin, then you need not ask the reference
wave function for the orbital energies.  Instead, you should use the 
eigenvalues of the Fock matrix constructed using your converged 
Hartree-Fock solution.  
<br>
<br>
For the water molecule in a minimal basis set (using the default input file 
with the small modifications given above),
the DF-MP2 correlation energy should be -0.031081575913 E<sub>h</sub>.  Once
your code can correctly recover the correlation energy for this neutral 
species, verify that you recover the correct correlation energy for an
open-shell molecule:
<br>
<br>
<pre class="prettyprint">

    molecule {
    1 2
    O
    H 1 R
    H 1 R 2 A

    R = .9
    A = 104.5
    # add this line!
    symmetry c1
    }

    set {
      basis sto-3g
      # add these lines!
      scf_type df
      reference uhf
    }

    energy('mymp2')

</pre>
<br>
In this case, the DF-MP2 correlation energy should be
-0.024767575359 E<sub>h</sub>.

<br>
<br>

<hr>

<br>
    
